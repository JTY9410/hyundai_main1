{% extends 'base.html' %}
{# Template recreated: 2025-10-31 - Fixed tzlocal error with safe filters #}
{% block title %}책임보험 승인{% endblock %}
{% block content %}
<div class="mb-4 flex gap-2 flex-wrap">
  <a href="{{ url_for('admin_home') }}" class="inline-flex items-center px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200"><i class="bi bi-arrow-left mr-2"></i>관리자페이지로</a>
  <a href="{{ url_for('admin_insurance_download') }}" class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors duration-200"><i class="bi bi-cloud-arrow-down mr-2"></i>데이터다운로드</a>
</div>

<div class="bg-white shadow-md rounded-lg p-6 mb-6">
  <form class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4" method="get">
    <div>
      <label class="block text-gray-700 text-sm font-bold mb-2">신청 시작일</label>
      <input type="date" name="req_start" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.args.get('req_start','') }}">
    </div>
    <div>
      <label class="block text-gray-700 text-sm font-bold mb-2">신청 종료일</label>
      <input type="date" name="req_end" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.args.get('req_end','') }}">
    </div>
    <div>
      <label class="block text-gray-700 text-sm font-bold mb-2">승인여부</label>
      <select name="approved" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        {% set a = request.args.get('approved','전체') %}
        <option value="전체" {% if a=='전체' %}selected{% endif %}>전체</option>
        <option value="승인" {% if a=='승인' %}selected{% endif %}>승인</option>
        <option value="미승인" {% if a=='미승인' %}selected{% endif %}>미승인</option>
      </select>
    </div>
    <div>
      <label class="block text-gray-700 text-sm font-bold mb-2">승인 시작</label>
      <input type="date" name="appr_start" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.args.get('appr_start','') }}">
    </div>
    <div>
      <label class="block text-gray-700 text-sm font-bold mb-2">승인 종료</label>
      <input type="date" name="appr_end" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="{{ request.args.get('appr_end','') }}">
    </div>
    <div class="flex items-end col-span-full lg:col-span-1">
      <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full" type="submit">검색</button>
    </div>
  </form>
</div>

<form method="post" class="mb-4">
  <input type="hidden" name="bulk_approve" value="1">
  <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit"><i class="bi bi-check-all mr-2"></i>일괄승인</button>
</form>

<div class="bg-white shadow-md rounded-lg p-6">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200 sticky-header table-auto">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[50px]">순</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[120px]">상사명</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[140px]">신청시간</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[120px]">가입희망일자</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[140px]">가입시간</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[140px]">종료시간</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[140px]">조합승인시간</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[120px]">피보험자코드</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[120px]">계약자코드</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[110px]">한글차량번호</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[140px]">차대번호</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[120px]">차량명</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[120px]">차량등록일자</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[90px]">보험료</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[100px]">조합승인</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[100px]">보험증권</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[150px]">비고</th>
          <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-50 z-10 min-w-[120px]">작업</th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% for r in rows %}
          <tr>
            <td class="px-4 py-2 whitespace-nowrap">{{ loop.index }}</td>
            <td class="px-4 py-2 whitespace-nowrap">{{ items[loop.index0].created_by_company }}</td>
            <td class="px-4 py-2 whitespace-nowrap">{{ items[loop.index0].created_at_str }}</td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <input type="date" name="desired_start_date" class="form-input block w-full text-sm" value="{{ r.desired_start_date }}" form="edit_form_{{ r.id }}">
              {% else %}
                {{ r.desired_start_date }}
              {% endif %}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <input type="datetime-local" name="start_at" class="form-input block w-full text-sm" value="{{ items[loop.index0].start_at_input }}" form="edit_form_{{ r.id }}">
              {% else %}
                {{ items[loop.index0].start_at_str }}
              {% endif %}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <input type="datetime-local" name="end_at" class="form-input block w-full text-sm" value="{{ items[loop.index0].end_at_input }}" form="edit_form_{{ r.id }}">
              {% else %}
                {{ items[loop.index0].end_at_str }}
              {% endif %}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">{{ items[loop.index0].approved_at_str }}</td>
            <td class="px-4 py-2 whitespace-nowrap">{{ r.insured_code }}</td>
            <td class="px-4 py-2 whitespace-nowrap">{{ r.contractor_code }}</td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <input type="text" name="car_plate" class="form-input block w-full text-sm" value="{{ r.car_plate }}" form="edit_form_{{ r.id }}">
              {% else %}
                {{ r.car_plate }}
              {% endif %}
            </td>
            <td class="px-4 py-2 text-sm break-all">
              {% if edit_id == r.id|string %}
                <input type="text" name="vin" class="form-input block w-full text-sm" value="{{ r.vin or '' }}" form="edit_form_{{ r.id }}">
              {% else %}
                {{ r.vin or '' }}
              {% endif %}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <input type="text" name="car_name" class="form-input block w-full text-sm" value="{{ r.car_name or '' }}" form="edit_form_{{ r.id }}">
              {% else %}
                {{ r.car_name or '' }}
              {% endif %}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <input type="date" name="car_registered_at" class="form-input block w-full text-sm" value="{{ r.car_registered_at or '' }}" form="edit_form_{{ r.id }}">
              {% else %}
                {{ r.car_registered_at or '' }}
              {% endif %}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">9,500</td>
            <td class="px-4 py-2 whitespace-nowrap">{{ '승인' if r.approved_at else '미승인' }}</td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <div class="space-y-2">
                  <input type="text" name="insurance_policy_url" class="form-input block w-full text-sm" value="{{ r.insurance_policy_url or '' }}" placeholder="보험증권 URL" form="edit_form_{{ r.id }}">
                  <input type="text" name="insurance_policy_path" class="form-input block w-full text-sm" value="{{ r.insurance_policy_path or '' }}" placeholder="보험증권 파일 경로" form="edit_form_{{ r.id }}">
                </div>
              {% elif r.insurance_policy_path or r.insurance_policy_url %}
                {% if r.insurance_policy_url %}
                  <a href="{{ r.insurance_policy_url }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline inline-flex items-center">
                    <i class="bi bi-file-earmark-pdf mr-1"></i>보험증권 보기
                  </a>
                {% elif r.insurance_policy_path %}
                  <a href="{{ url_for('serve_insurance_policy', insurance_id=r.id) }}" target="_blank" class="text-blue-600 hover:text-blue-800 underline inline-flex items-center">
                    <i class="bi bi-file-earmark-pdf mr-1"></i>보험증권 보기
                  </a>
                {% endif %}
              {% else %}
                <span class="text-gray-400">-</span>
              {% endif %}
            </td>
            <td class="px-4 py-2 text-sm break-words">
              {% if edit_id == r.id|string %}
                <input type="text" name="memo" class="form-input block w-full text-sm" value="{{ r.memo or '' }}" form="edit_form_{{ r.id }}">
              {% else %}
                <form method="post" class="inline-flex items-center space-x-2">
                  <input type="hidden" name="row_id" value="{{ r.id }}">
                  <input type="hidden" name="action" value="save_memo">
                  <div class="relative flex items-center w-full">
                    <input type="text" name="memo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline text-sm" value="{{ r.memo or '' }}" placeholder="비고 입력" onkeypress="if(event.key==='Enter'){this.form.submit();}">
                    <button class="absolute right-0 top-0 mt-1 mr-1 p-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:shadow-outline" type="submit" title="저장"><i class="bi bi-check-lg"></i></button>
                  </div>
                </form>
              {% endif %}
            </td>
            <td class="px-4 py-2 whitespace-nowrap">
              {% if edit_id == r.id|string %}
                <form id="edit_form_{{ r.id }}" method="post" class="inline-flex space-x-2">
                  <input type="hidden" name="row_id" value="{{ r.id }}">
                  <input type="hidden" name="action" value="save">
                  <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">저장</button>
                  <a href="{{ url_for('admin_insurance', req_start=request.args.get('req_start'), req_end=request.args.get('req_end'), approved=request.args.get('approved'), appr_start=request.args.get('appr_start'), appr_end=request.args.get('appr_end')) }}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">취소</a>
                </form>
              {% else %}
                {% if not r.approved_at %}
                <form method="post" class="inline-block mr-2" onsubmit="console.log('Submitting approve form for row {{ r.id }}');">
                  <input type="hidden" name="row_id" value="{{ r.id }}">
                  <input type="hidden" name="action" value="approve">
                  <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline text-sm">승인</button>
                </form>
                {% else %}
                <span class="text-green-600 font-semibold">승인완료</span>
                {% endif %}
                <a href="{{ url_for('admin_insurance', edit_id=r.id, req_start=request.args.get('req_start'), req_end=request.args.get('req_end'), approved=request.args.get('approved'), appr_start=request.args.get('appr_start'), appr_end=request.args.get('appr_end')) }}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">수정</a>
                <form method="post" class="inline-block ml-2" onsubmit="return confirm('삭제하시겠습니까?')">
                  <input type="hidden" name="row_id" value="{{ r.id }}">
                  <input type="hidden" name="action" value="delete">
                  <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">삭제</button>
                </form>
                {# Removed hidden approve form; using explicit form above for reliability #}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}


