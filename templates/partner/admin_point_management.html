{% extends 'base.html' %}

{% block title %}포인트관리 - {{ partner_group_name or '파트너그룹' }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50/30 to-indigo-50/20 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
      <div>
        <h1 class="text-3xl font-bold gradient-text">포인트관리</h1>
        <p class="text-gray-600 mt-2">{{ partner_group_name }} 파트너그룹의 포인트 및 입금현황을 관리합니다</p>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <a href="{{ url_for('partner_admin') }}"
           class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white font-medium rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all duration-200">
          <i class="bi bi-arrow-left mr-2"></i>관리자페이지
        </a>
      </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-6">
          {% for category, message in messages %}
            <div class="p-4 rounded-xl mb-3 border-l-4 {% if category == 'success' %}bg-green-50 text-green-800 border-green-500{% elif category == 'danger' %}bg-red-50 text-red-800 border-red-500{% elif category == 'warning' %}bg-yellow-50 text-yellow-800 border-yellow-500{% else %}bg-blue-50 text-blue-800 border-blue-500{% endif %}">
              <div class="flex items-center">
                <i class="bi {% if category == 'success' %}bi-check-circle-fill{% elif category == 'danger' %}bi-exclamation-circle-fill{% elif category == 'warning' %}bi-exclamation-triangle-fill{% else %}bi-info-circle-fill{% endif %} mr-3"></i>
                <span class="font-medium">{{ message }}</span>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
      <!-- Deposit Form -->
      <div class="glass rounded-2xl p-6 border border-white/50 backdrop-blur-xl lg:col-span-2">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="bi bi-bank mr-2 text-blue-600"></i>입금현황 입력
        </h2>
        <form method="post" class="space-y-4" id="deposit-form">
          <input type="hidden" name="action" value="deposit">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">회원 선택 (아이디)</label>
              <select name="member_id" id="deposit-member-select"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">회원을 선택하세요</option>
                {% for member in members %}
                  <option value="{{ member.id }}">{{ member.username }} ({{ member.company_name or '상사명 없음' }})</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">입금일시</label>
              <input type="datetime-local" name="deposit_date"
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">은행</label>
              <input type="text" name="bank_name" id="deposit-bank-name" required
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                     placeholder="예: 국민은행">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">계좌번호</label>
              <input type="text" name="account_number" id="deposit-account-number" required
                     class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                     placeholder="예: 000-0000-0000">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">입금액</label>
              <select name="deposit_amount" required
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">금액을 선택하세요</option>
                <option value="100000">100,000원</option>
                <option value="200000">200,000원</option>
                <option value="300000">300,000원</option>
                <option value="400000">400,000원</option>
                <option value="500000">500,000원</option>
                <option value="600000">600,000원</option>
                <option value="700000">700,000원</option>
                <option value="800000">800,000원</option>
                <option value="900000">900,000원</option>
                <option value="1000000">1,000,000원</option>
                <option value="1100000">1,100,000원</option>
                <option value="1200000">1,200,000원</option>
                <option value="1300000">1,300,000원</option>
                <option value="1400000">1,400,000원</option>
                <option value="1500000">1,500,000원</option>
                <option value="1600000">1,600,000원</option>
                <option value="1700000">1,700,000원</option>
                <option value="1800000">1,800,000원</option>
                <option value="1900000">1,900,000원</option>
                <option value="2000000">2,000,000원</option>
              </select>
            </div>
          </div>
          <div class="flex flex-wrap items-center gap-3">
            <button type="submit"
                    class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-medium rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all duration-200">
              <i class="bi bi-save mr-2"></i>입금현황입력
            </button>
            <button type="reset"
                    class="inline-flex items-center px-5 py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white font-medium rounded-lg hover:from-gray-600 hover:to-gray-700 transition-all duration-200">
              <i class="bi bi-arrow-counterclockwise mr-2"></i>초기화
            </button>
          </div>
        </form>
      </div>

      <!-- Excel Download -->
      <div class="glass rounded-2xl p-6 border border-white/50 backdrop-blur-xl">
        <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="bi bi-file-earmark-spreadsheet mr-2 text-emerald-600"></i>엑셀 다운로드
        </h2>
        <p class="text-sm text-gray-600 mb-6">
          현재 파트너그룹의 포인트현황 데이터를 엑셀 파일로 다운로드할 수 있습니다.
        </p>
        <form method="post">
          <input type="hidden" name="action" value="export_excel">
          <button type="submit"
                  class="w-full inline-flex items-center justify-center px-5 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white font-medium rounded-lg hover:from-emerald-600 hover:to-green-700 transition-all duration-200">
            <i class="bi bi-download mr-2"></i>엑셀다운로드
          </button>
        </form>
      </div>
    </div>

    <!-- Member Table -->
    <div class="glass rounded-2xl border border-white/50 backdrop-blur-xl overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 table-auto">
          <thead class="bg-gradient-to-r from-indigo-600 via-blue-600 to-cyan-500 text-white">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">아이디</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">상사명</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">대표자</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">사업자번호</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">포인트현황</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">최근입금현황 (최근 3건)</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">비고</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider">작업</th>
            </tr>
          </thead>
          <tbody class="bg-white/60 divide-y divide-gray-200">
            {% for row in member_rows %}
              <tr class="hover:bg-blue-50/40 transition-colors duration-200">
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ row.member.username }}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ row.member.company_name or '-' }}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ row.member.representative or '-' }}</td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700">{{ row.member.business_number or '-' }}</td>
                <td class="px-4 py-3 text-sm text-gray-900">
                  <div class="flex flex-col space-y-1">
                    <span>잔류포인트: <span class="font-semibold text-blue-600">{{ "{:,.0f}".format(row.point_balance) }}원</span></span>
                    <span>누적입금액: <span class="font-semibold text-emerald-600">{{ "{:,.0f}".format(row.total_deposit) }}원</span></span>
                  </div>
                </td>
                <td class="px-4 py-3 text-sm text-gray-700">
                  {% if row.recent_deposits %}
                    <ul class="space-y-1">
                      {% for deposit in row.recent_deposits %}
                        <li class="flex items-center text-gray-600">
                          <i class="bi bi-chevron-right text-xs mr-2 text-gray-400"></i>{{ deposit }}
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <span class="text-gray-400">-</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3 text-sm text-gray-700">
                  {% if row.last_adjustment_note %}
                    <div class="flex flex-col space-y-1">
                      <span class="text-gray-700">{{ row.last_adjustment_note }}</span>
                      {% if row.last_adjustment_at %}
                        <span class="text-xs text-gray-400">{{ row.last_adjustment_at.strftime('%Y-%m-%d %H:%M') }}</span>
                      {% endif %}
                    </div>
                  {% else %}
                    <span class="text-gray-400">-</span>
                  {% endif %}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm">
                  <div class="flex flex-col sm:flex-row sm:items-center gap-2">
                    <button type="button"
                            class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white text-xs font-medium rounded-lg hover:from-blue-600 hover:to-indigo-700 transition-all duration-200"
                            data-member-id="{{ row.member.id }}"
                            data-member-username="{{ row.member.username }}"
                            data-company-name="{{ row.member.company_name or '' }}"
                            onclick="prefillDepositForm(this)">
                      <i class="bi bi-pencil-square mr-1"></i>입금현황입력
                    </button>
                    <button type="button"
                            class="inline-flex items-center px-3 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white text-xs font-medium rounded-lg hover:from-amber-600 hover:to-orange-600 transition-all duration-200"
                            data-member-id="{{ row.member.id }}"
                            data-member-username="{{ row.member.username }}"
                            data-company-name="{{ row.member.company_name or '' }}"
                            data-point-balance="{{ row.point_balance }}"
                            data-last-note="{{ row.last_adjustment_note|default('', true)|e }}"
                            onclick="openPointAdjustModal(this)">
                      <i class="bi bi-sliders mr-1"></i>포인트수정
                    </button>
                  </div>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                  <i class="bi bi-inbox text-4xl mb-2 block"></i>
                  등록된 회원이 없습니다.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Point Adjustment Modal -->
<div id="point-adjust-modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closePointAdjustModal()"></div>
  <div class="relative max-w-2xl mx-auto mt-16 bg-white rounded-2xl shadow-2xl overflow-hidden animate-[fade-in_0.25s_ease-out]">
    <div class="flex items-center justify-between px-6 py-4 bg-gradient-to-r from-amber-500 to-orange-500 text-white">
      <div>
        <h3 class="text-lg font-bold">포인트 수정</h3>
        <p class="text-xs text-white/80 mt-1">회원사의 포인트를 차감하거나 증가시킬 수 있습니다.</p>
      </div>
      <button type="button" class="text-white/80 hover:text-white text-xl" onclick="closePointAdjustModal()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <form method="post" id="point-adjust-form" class="px-6 py-6 space-y-6">
      <input type="hidden" name="action" value="adjust_points">
      <input type="hidden" name="member_id" id="point-adjust-member-id">
      <input type="hidden" id="point-adjust-current-balance" value="0">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-slate-50 rounded-xl p-4 border border-slate-200">
        <div>
          <p class="text-xs text-slate-500">회원아이디</p>
          <p class="text-base font-semibold text-slate-800" id="point-adjust-member-name">-</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">상사명</p>
          <p class="text-base font-semibold text-slate-800" id="point-adjust-company-name">-</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">현재 잔류포인트</p>
          <p class="text-lg font-bold text-blue-600" id="point-adjust-current-display">0원</p>
        </div>
        <div>
          <p class="text-xs text-slate-500">최근 수정 내역</p>
          <p class="text-sm text-slate-600" id="point-adjust-last-note">-</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">포인트 차감</label>
          <div class="relative">
            <input type="number" min="0" step="1" name="point_decrease" id="point-decrease-input"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                   placeholder="차감할 포인트를 입력하세요" oninput="updatePointAdjustmentResult()">
            <span class="absolute inset-y-0 right-3 flex items-center text-sm text-gray-400">원</span>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">포인트 증가</label>
          <div class="relative">
            <input type="number" min="0" step="1" name="point_increase" id="point-increase-input"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                   placeholder="증가할 포인트를 입력하세요" oninput="updatePointAdjustmentResult()">
            <span class="absolute inset-y-0 right-3 flex items-center text-sm text-gray-400">원</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">변경 후 잔류포인트</label>
          <input type="text" id="point-adjust-result" readonly
                 class="w-full px-4 py-3 border border-gray-200 rounded-lg bg-gray-100 text-gray-700 font-semibold">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">변경내역 기록</label>
          <textarea name="change_note" id="point-adjust-note"
                    class="w-full h-full min-h-[112px] px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                    placeholder="변경 사유를 입력해주세요 (예: 포인트차감 10,000원/포인트 반환)"></textarea>
        </div>
      </div>

      <div class="flex items-center justify-end gap-3 pt-4 border-t border-gray-100">
        <button type="button"
                class="inline-flex items-center px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                onclick="closePointAdjustModal()">
          취소
        </button>
        <button type="submit"
                class="inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-semibold rounded-lg hover:from-amber-600 hover:to-orange-600 transition-all duration-200">
          <i class="bi bi-check-lg mr-2"></i>포인트 수정 저장
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function prefillDepositForm(button) {
  const memberId = button.getAttribute('data-member-id');
  const memberSelect = document.getElementById('deposit-member-select');
  if (memberId && memberSelect) {
    memberSelect.value = memberId;
  }
}

function openPointAdjustModal(button) {
  const modal = document.getElementById('point-adjust-modal');
  const memberIdInput = document.getElementById('point-adjust-member-id');
  const currentBalanceInput = document.getElementById('point-adjust-current-balance');
  const currentDisplay = document.getElementById('point-adjust-current-display');
  const lastNoteDisplay = document.getElementById('point-adjust-last-note');
  const memberNameDisplay = document.getElementById('point-adjust-member-name');
  const companyNameDisplay = document.getElementById('point-adjust-company-name');
  const decreaseInput = document.getElementById('point-decrease-input');
  const increaseInput = document.getElementById('point-increase-input');
  const noteInput = document.getElementById('point-adjust-note');

  const memberId = button.getAttribute('data-member-id');
  const memberUsername = button.getAttribute('data-member-username') || '-';
  const companyName = button.getAttribute('data-company-name') || '-';
  const lastNote = button.getAttribute('data-last-note') || '-';
  const currentBalance = parseInt(button.getAttribute('data-point-balance') || '0', 10) || 0;

  memberIdInput.value = memberId;
  currentBalanceInput.value = currentBalance;
  memberNameDisplay.textContent = memberUsername;
  companyNameDisplay.textContent = companyName || '-';
  currentDisplay.textContent = new Intl.NumberFormat('ko-KR').format(currentBalance) + '원';
  lastNoteDisplay.textContent = lastNote && lastNote.trim().length > 0 ? lastNote : '-';

  if (decreaseInput) decreaseInput.value = '';
  if (increaseInput) increaseInput.value = '';
  if (noteInput) noteInput.value = '';

  updatePointAdjustmentResult();

  if (modal) {
    modal.classList.remove('hidden');
  }
}

function closePointAdjustModal() {
  const modal = document.getElementById('point-adjust-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

function updatePointAdjustmentResult() {
  const currentBalance = parseInt(document.getElementById('point-adjust-current-balance').value || '0', 10) || 0;
  const decreaseInput = document.getElementById('point-decrease-input');
  const increaseInput = document.getElementById('point-increase-input');
  const resultDisplay = document.getElementById('point-adjust-result');

  let decrease = parseInt(decreaseInput && decreaseInput.value ? decreaseInput.value : '0', 10);
  let increase = parseInt(increaseInput && increaseInput.value ? increaseInput.value : '0', 10);

  if (isNaN(decrease) || decrease < 0) decrease = 0;
  if (isNaN(increase) || increase < 0) increase = 0;

  let newBalance = currentBalance - decrease + increase;
  if (newBalance < 0) newBalance = 0;

  if (resultDisplay) {
    resultDisplay.value = new Intl.NumberFormat('ko-KR').format(newBalance) + '원';
  }
}
</script>
{% endblock %}

